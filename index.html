<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Multi-Tool 90s Dark App</title>
  <style>
    /* Overall container as a flex row */
    html, body {
      height: 100%;
      margin: 0;
      font-family: "Courier New", Courier, monospace;
      background: #222;
      color: #eee;
      overflow: hidden;
    }
    #container {
      display: flex;
      height: 100%;
      width: 100%;
      position: relative;
    }
    .column {
      height: 100%;
      overflow: auto;
      padding: 8px;
      box-sizing: border-box;
      background: #333;
      border: 2px solid #555;
    }
    /* Three columns: Column 1 is widest initially */
    #col1 {
      flex: 2 1 0;
      position: relative;
    }
    #col2 {
      flex: 1 1 0;
      display: flex;
      flex-direction: column;
    }
    #col3 {
      flex: 1 1 0;
    }
    /* Draggable divider style */
    .divider {
      width: 5px;
      cursor: ew-resize;
      background: #444;
    }
    /* PDF Tabs and Viewer */
    #pdf-tabs {
      display: flex;
      align-items: center;
      border-bottom: 2px solid #555;
      padding-bottom: 4px;
      margin-bottom: 4px;
    }
    #pdf-tabs button {
      margin-right: 4px;
      background: #555;
      color: #eee;
      border: none;
      padding: 2px 6px;
      cursor: pointer;
    }
    #tabs-container {
      display: flex;
      overflow-x: auto;
    }
    .pdf-tab {
      background: #666;
      padding: 4px 8px;
      margin-right: 4px;
      cursor: pointer;
      border: 1px solid #888;
      white-space: nowrap;
      position: relative;
    }
    .pdf-tab.active {
      background: #888;
    }
    .pdf-tab .close-tab {
      position: absolute;
      top: 0;
      right: 2px;
      color: #f88;
      cursor: pointer;
      font-weight: bold;
    }
    #pdf-viewer-container {
      position: relative;
      text-align: center;
    }
    #pdf-canvas {
      max-width: 100%;
      height: auto;
      background: #000;
    }
    /* Floating PDF Navigation Bar */
    .floating-nav {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #555;
      border: 2px solid #777;
      padding: 4px;
      z-index: 10;
      cursor: move;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .floating-nav input[type="number"] {
      width: 40px;
      background: #444;
      border: 1px solid #666;
      color: #eee;
    }
    .floating-nav button {
      background: #444;
      border: 1px solid #666;
      color: #eee;
      cursor: pointer;
    }
    /* Markdown Note Taking */
    #markdown-area {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    #raw-markdown {
      flex: 1;
      resize: none;
      background: #444;
      border: 1px solid #666;
      color: #eee;
      padding: 8px;
      font-family: monospace;
    }
    /* Rendered Markdown styled as a legal document */
    #rendered-markdown {
      flex: 1;
      overflow: auto;
      background: #1e1e1e;
      border: 1px solid #666;
      padding: 16px;
      font-family: "Times New Roman", Georgia, serif;
      font-size: 14pt;
      line-height: 1.6;
      text-align: justify;
      margin-top: 4px;
    }
    /* Legal documentâ€“inspired headings */
    #rendered-markdown h1,
    #rendered-markdown h2,
    #rendered-markdown h3,
    #rendered-markdown h4,
    #rendered-markdown h5,
    #rendered-markdown h6 {
      font-family: "Times New Roman", Georgia, serif;
      font-weight: bold;
      text-transform: uppercase;
      border-bottom: 1px solid #777;
      padding-bottom: 4px;
      margin-top: 20px;
      margin-bottom: 10px;
    }
    #markdown-area > div {
      margin-top: 4px;
      text-align: center;
    }
    #markdown-area button {
      background: #555;
      border: 1px solid #777;
      color: #eee;
      margin: 0 4px;
      padding: 4px 8px;
      cursor: pointer;
    }
    /* Wikipedia Search */
    #wiki-search {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    #wiki-query {
      padding: 4px;
      margin-bottom: 4px;
      background: #444;
      border: 1px solid #666;
      color: #eee;
    }
    #wiki-results {
      flex: 1;
      overflow: auto;
    }
    .wiki-item {
      border-bottom: 1px solid #555;
      padding: 4px;
      display: flex;
      gap: 4px;
      align-items: flex-start;
    }
    .wiki-item img {
      width: 50px;
      height: auto;
    }
    .wiki-item a {
      color: #9cf;
      text-decoration: none;
    }
    .wiki-item a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- Column 1: PDF Upload/Viewer -->
    <div id="col1" class="column">
      <div id="pdf-tabs">
        <button id="upload-pdf-btn">Upload PDF</button>
        <input type="file" id="pdf-upload" accept="application/pdf" style="display:none" />
        <div id="tabs-container"></div>
      </div>
      <div id="pdf-viewer-container">
        <canvas id="pdf-canvas"></canvas>
        <div id="pdf-nav" class="floating-nav">
          <button id="prev-page">&laquo; Prev</button>
          <span>Page <input type="number" id="current-page" min="1"> of <span id="total-pages">0</span></span>
          <button id="next-page">Next &raquo;</button>
        </div>
      </div>
    </div>
    <!-- Divider between column 1 and 2 -->
    <div id="divider1" class="divider"></div>
    <!-- Column 2: Markdown Note Taking -->
    <div id="col2" class="column">
      <div id="markdown-area">
        <textarea id="raw-markdown" placeholder="Enter markdown notes here..."></textarea>
        <div>
          <button id="save-raw">Save Raw Markdown</button>
          <button id="save-word">Save as Word Document</button>
        </div>
        <div id="rendered-markdown"></div>
      </div>
    </div>
    <!-- Divider between column 2 and 3 -->
    <div id="divider2" class="divider"></div>
    <!-- Column 3: Wikipedia Search -->
    <div id="col3" class="column">
      <div id="wiki-search">
        <input type="text" id="wiki-query" placeholder="Search Wikipedia...">
        <div id="wiki-results"></div>
      </div>
    </div>
  </div>

  <!-- Include PDF.js and Marked.js from CDNs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.2.12/marked.min.js"></script>
  <script>
    /************ Resizable Columns ************/
    (function() {
      let isDragging = false;
      let currentDivider;
      let startX, startWidthLeft, startWidthRight;
      
      function onMouseMove(e) {
        if (!isDragging) return;
        let dx = e.clientX - startX;
        if (currentDivider.id === "divider1") {
          // Adjust col1 and col2 widths
          currentDivider.previousElementSibling.style.flex = "0 0 " + (startWidthLeft + dx) + "px";
          currentDivider.nextElementSibling.style.flex = "0 0 " + (startWidthRight - dx) + "px";
        } else if (currentDivider.id === "divider2") {
          // Adjust col2 and col3 widths
          currentDivider.previousElementSibling.style.flex = "0 0 " + (startWidthLeft + dx) + "px";
          currentDivider.nextElementSibling.style.flex = "0 0 " + (startWidthRight - dx) + "px";
        }
      }
      function onMouseUp() {
        isDragging = false;
        document.removeEventListener("mousemove", onMouseMove);
        document.removeEventListener("mouseup", onMouseUp);
      }
      document.querySelectorAll(".divider").forEach(divider => {
        divider.addEventListener("mousedown", function(e) {
          isDragging = true;
          currentDivider = divider;
          startX = e.clientX;
          startWidthLeft = currentDivider.previousElementSibling.getBoundingClientRect().width;
          startWidthRight = currentDivider.nextElementSibling.getBoundingClientRect().width;
          document.addEventListener("mousemove", onMouseMove);
          document.addEventListener("mouseup", onMouseUp);
        });
      });
    })();

    /************ PDF Viewer & Tabs ************/
    const pdfTabs = [];
    let activePdfTab = null;
    const tabsContainer = document.getElementById("tabs-container");
    const pdfUploadInput = document.getElementById("pdf-upload");
    const uploadPdfBtn = document.getElementById("upload-pdf-btn");
    const canvas = document.getElementById("pdf-canvas");
    const ctx = canvas.getContext("2d");
    const prevBtn = document.getElementById("prev-page");
    const nextBtn = document.getElementById("next-page");
    const currentPageInput = document.getElementById("current-page");
    const totalPagesSpan = document.getElementById("total-pages");

    uploadPdfBtn.addEventListener("click", () => pdfUploadInput.click());
    pdfUploadInput.addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (file && file.type === "application/pdf") {
        const reader = new FileReader();
        reader.onload = function() {
          const arrayBuffer = reader.result;
          const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
          loadingTask.promise.then(pdfDoc => {
            const tab = {
              id: Date.now(),
              title: file.name.length > 15 ? file.name.substring(0, 12) + "..." : file.name,
              pdfDoc: pdfDoc,
              currentPage: 1,
              totalPages: pdfDoc.numPages
            };
            pdfTabs.push(tab);
            addTabElement(tab);
            setActiveTab(tab.id);
          });
        };
        reader.readAsArrayBuffer(file);
      }
      // Reset file input for same file upload
      e.target.value = "";
    });

    function addTabElement(tab) {
      const tabEl = document.createElement("div");
      tabEl.classList.add("pdf-tab");
      tabEl.dataset.id = tab.id;
      tabEl.textContent = tab.title;
      const closeBtn = document.createElement("span");
      closeBtn.textContent = "Ã—";
      closeBtn.classList.add("close-tab");
      closeBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        removeTab(tab.id);
      });
      tabEl.appendChild(closeBtn);
      tabEl.addEventListener("click", () => setActiveTab(tab.id));
      tabsContainer.appendChild(tabEl);
    }

    function removeTab(tabId) {
      const index = pdfTabs.findIndex(t => t.id == tabId);
      if (index !== -1) {
        pdfTabs.splice(index, 1);
        const tabEl = tabsContainer.querySelector(`[data-id="${tabId}"]`);
        if (tabEl) tabEl.remove();
        // If the active tab was removed, choose another one
        if (activePdfTab && activePdfTab.id == tabId) {
          if (pdfTabs.length > 0) {
            setActiveTab(pdfTabs[pdfTabs.length - 1].id);
          } else {
            activePdfTab = null;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            totalPagesSpan.textContent = "0";
            currentPageInput.value = "";
          }
        }
      }
    }

    function setActiveTab(tabId) {
      activePdfTab = pdfTabs.find(t => t.id == tabId);
      // Mark tab as active
      document.querySelectorAll(".pdf-tab").forEach(el => {
        el.classList.toggle("active", el.dataset.id == tabId);
      });
      renderPage(activePdfTab.currentPage);
    }

    function renderPage(num) {
      if (!activePdfTab) return;
      activePdfTab.pdfDoc.getPage(num).then(page => {
        const viewport = page.getViewport({ scale: 1.5 });
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const renderContext = {
          canvasContext: ctx,
          viewport: viewport
        };
        page.render(renderContext);
        activePdfTab.currentPage = num;
        currentPageInput.value = num;
        totalPagesSpan.textContent = activePdfTab.totalPages;
      });
    }

    prevBtn.addEventListener("click", () => {
      if (activePdfTab && activePdfTab.currentPage > 1) {
        renderPage(activePdfTab.currentPage - 1);
      }
    });
    nextBtn.addEventListener("click", () => {
      if (activePdfTab && activePdfTab.currentPage < activePdfTab.totalPages) {
        renderPage(activePdfTab.currentPage + 1);
      }
    });
    currentPageInput.addEventListener("change", () => {
      let p = parseInt(currentPageInput.value);
      if (activePdfTab && p >= 1 && p <= activePdfTab.totalPages) {
        renderPage(p);
      }
    });

    // Make the PDF nav bar draggable
    (function() {
      const nav = document.getElementById("pdf-nav");
      let offsetX, offsetY, dragging = false;
      nav.addEventListener("mousedown", function(e) {
        dragging = true;
        offsetX = e.clientX - nav.offsetLeft;
        offsetY = e.clientY - nav.offsetTop;
        document.addEventListener("mousemove", moveNav);
        document.addEventListener("mouseup", () => {
          dragging = false;
          document.removeEventListener("mousemove", moveNav);
        });
      });
      function moveNav(e) {
        if (dragging) {
          nav.style.left = (e.clientX - offsetX) + "px";
          nav.style.top = (e.clientY - offsetY) + "px";
        }
      }
    })();

    /************ Markdown Note Taking ************/
    const rawMarkdown = document.getElementById("raw-markdown");
    const renderedMarkdown = document.getElementById("rendered-markdown");
    const saveRawBtn = document.getElementById("save-raw");
    const saveWordBtn = document.getElementById("save-word");

    // Update rendered markdown live
    rawMarkdown.addEventListener("input", () => {
      renderedMarkdown.innerHTML = marked.parse(rawMarkdown.value);
    });

    saveRawBtn.addEventListener("click", () => {
      const blob = new Blob([rawMarkdown.value], { type: "text/markdown;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "notes.md";
      a.click();
    });

    saveWordBtn.addEventListener("click", () => {
      const content = `
        <html>
          <head>
            <meta charset="utf-8">
            <title>Markdown as Word Document</title>
          </head>
          <body>${renderedMarkdown.innerHTML}</body>
        </html>`;
      const blob = new Blob([content], { type: "application/msword" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "notes.doc";
      a.click();
    });

    /************ Wikipedia Live Search ************/
    const wikiQuery = document.getElementById("wiki-query");
    const wikiResults = document.getElementById("wiki-results");
    let debounceTimeout;
    wikiQuery.addEventListener("input", () => {
      clearTimeout(debounceTimeout);
      const query = wikiQuery.value.trim();
      if (!query) {
        wikiResults.innerHTML = "";
        return;
      }
      debounceTimeout = setTimeout(() => {
        fetch(`https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*&generator=search&gsrsearch=${encodeURIComponent(query)}&prop=pageimages|extracts&exintro=1&exsentences=2&exlimit=max&pithumbsize=100`)
          .then(res => res.json())
          .then(data => {
            wikiResults.innerHTML = "";
            if(data.query && data.query.pages){
              // Convert pages object to sorted array
              const pages = Object.values(data.query.pages).sort((a, b) => a.index - b.index);
              pages.forEach(page => {
                const item = document.createElement("div");
                item.classList.add("wiki-item");
                if(page.thumbnail && page.thumbnail.source){
                  const img = document.createElement("img");
                  img.src = page.thumbnail.source;
                  item.appendChild(img);
                }
                const contentDiv = document.createElement("div");
                const titleLink = document.createElement("a");
                titleLink.href = `https://en.wikipedia.org/?curid=${page.pageid}`;
                titleLink.target = "_blank";
                titleLink.textContent = page.title;
                contentDiv.appendChild(titleLink);
                const snippet = document.createElement("div");
                snippet.innerHTML = page.extract || "";
                contentDiv.appendChild(snippet);
                item.appendChild(contentDiv);
                wikiResults.appendChild(item);
              });
            } else {
              wikiResults.innerHTML = "<div>No results found.</div>";
            }
          })
          .catch(err => {
            wikiResults.innerHTML = "<div>Error fetching results.</div>";
            console.error(err);
          });
      }, 300);
    });
  </script>
</body>
</html>
