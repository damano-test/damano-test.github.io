<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three-Column Web App</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .app {
            display: flex;
            height: 100vh;
            background-color: #333;
            color: #eee;
            font-family: 'Courier New', Courier, monospace;
        }
        .column {
            overflow: auto;
            padding: 10px;
            box-sizing: border-box;
        }
        .resize-handle {
            width: 5px;
            height: 100%;
            background-color: #555;
            cursor: col-resize;
        }
        #column1 {
            width: 40%;
        }
        #column2 {
            width: 30%;
            display: flex;
            flex-direction: column;
        }
        #column3 {
            width: 30%;
        }
        .tab-bar {
            display: flex;
            overflow-x: auto;
            margin-bottom: 10px;
        }
        .tab {
            padding: 5px 10px;
            background-color: #444;
            margin-right: 2px;
            cursor: pointer;
            white-space: nowrap;
        }
        .tab.active {
            background-color: #666;
        }
        .close-tab {
            margin-left: 5px;
            background: none;
            border: none;
            color: #eee;
            cursor: pointer;
        }
        .pdf-viewer {
            position: relative;
        }
        .nav-bar {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: #444;
            padding: 5px;
            border-radius: 5px;
            cursor: move;
            user-select: none;
        }
        #pdf-canvas {
            max-width: 100%;
        }
        #markdown-input {
            height: 50%;
            resize: none;
            background-color: #222;
            color: #eee;
            border: 1px solid #555;
            padding: 5px;
            font-family: inherit;
            box-sizing: border-box;
        }
        #markdown-rendered {
            height: 50%;
            overflow: auto;
            background-color: #222;
            border: 1px solid #555;
            padding: 5px;
            box-sizing: border-box;
        }
        #save-md, #export-word {
            margin-top: 5px;
            background-color: #444;
            color: #eee;
            border: 1px solid #555;
            padding: 5px;
            cursor: pointer;
        }
        #wiki-search {
            width: 100%;
            background-color: #222;
            color: #eee;
            border: 1px solid #555;
            padding: 5px;
            font-family: inherit;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        .wiki-result {
            margin-bottom: 10px;
            overflow: hidden;
        }
        .wiki-result h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }
        .wiki-result p {
            margin: 0 0 5px 0;
            font-size: 14px;
        }
        .wiki-result a {
            color: #aaf;
            text-decoration: none;
        }
        .wiki-result img {
            width: 50px;
            height: 50px;
            float: left;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="column" id="column1">
            <div class="tab-bar" id="pdf-tabs">
                <input type="file" id="pdf-upload" accept=".pdf" style="display: none;">
                <button id="upload-button">Upload PDF</button>
            </div>
            <div class="pdf-viewer">
                <canvas id="pdf-canvas"></canvas>
                <div class="nav-bar" id="pdf-nav">
                    <button id="prev-page">Prev</button>
                    <input type="number" id="page-num" min="1" style="width: 50px;">
                    <span id="page-count"></span>
                    <button id="next-page">Next</button>
                </div>
            </div>
        </div>
        <div class="resize-handle" id="handle1"></div>
        <div class="column" id="column2">
            <textarea id="markdown-input" placeholder="Enter Markdown here..."></textarea>
            <div id="markdown-rendered"></div>
            <button id="save-md">Save Markdown</button>
            <button id="export-word">Export to Word</button>
        </div>
        <div class="resize-handle" id="handle2"></div>
        <div class="column" id="column3">
            <input type="text" id="wiki-search" placeholder="Search Wikipedia">
            <div id="wiki-results"></div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/2.0.3/marked.min.js"></script>
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

        // DOM elements
        const column1 = document.getElementById('column1');
        const column2 = document.getElementById('column2');
        const column3 = document.getElementById('column3');
        const handle1 = document.getElementById('handle1');
        const handle2 = document.getElementById('handle2');
        const pdfTabs = document.getElementById('pdf-tabs');
        const pdfUpload = document.getElementById('pdf-upload');
        const uploadButton = document.getElementById('upload-button');
        const pdfCanvas = document.getElementById('pdf-canvas');
        const navBar = document.getElementById('pdf-nav');
        const prevPage = document.getElementById('prev-page');
        const nextPage = document.getElementById('next-page');
        const pageNum = document.getElementById('page-num');
        const pageCount = document.getElementById('page-count');
        const markdownInput = document.getElementById('markdown-input');
        const markdownRendered = document.getElementById('markdown-rendered');
        const saveMdButton = document.getElementById('save-md');
        const exportWordButton = document.getElementById('export-word');
        const wikiSearch = document.getElementById('wiki-search');
        const wikiResults = document.getElementById('wiki-results');

        // PDF management
        let pdfs = [];
        let activePdfId = null;

        // Column resizing
        let isResizing = false;
        let currentHandle = null;
        let startX = 0;

        function startResize(e, handle) {
            isResizing = true;
            currentHandle = handle;
            startX = e.clientX;
        }

        function resize(e) {
            if (!isResizing) return;
            const delta = e.clientX - startX;
            startX = e.clientX;
            if (currentHandle === handle1) {
                const newWidth1 = column1.offsetWidth + delta;
                const newWidth2 = column2.offsetWidth - delta;
                if (newWidth1 > 100 && newWidth2 > 100) {
                    column1.style.width = `${newWidth1}px`;
                    column2.style.width = `${newWidth2}px`;
                }
            } else if (currentHandle === handle2) {
                const newWidth2 = column2.offsetWidth + delta;
                const newWidth3 = column3.offsetWidth - delta;
                if (newWidth2 > 100 && newWidth3 > 100) {
                    column2.style.width = `${newWidth2}px`;
                    column3.style.width = `${newWidth3}px`;
                }
            }
        }

        function stopResize() {
            isResizing = false;
            currentHandle = null;
        }

        handle1.addEventListener('mousedown', e => startResize(e, handle1));
        handle2.addEventListener('mousedown', e => startResize(e, handle2));
        document.addEventListener('mousemove', resize);
        document.addEventListener('mouseup', stopResize);

        // Navigation bar dragging
        let isDragging = false;
        let offsetX, offsetY;

        navBar.addEventListener('mousedown', e => {
            isDragging = true;
            offsetX = e.clientX - navBar.offsetLeft;
            offsetY = e.clientY - navBar.offsetTop;
        });

        document.addEventListener('mousemove', e => {
            if (isDragging) {
                const viewerRect = document.querySelector('.pdf-viewer').getBoundingClientRect();
                let newLeft = e.clientX - offsetX;
                let newTop = e.clientY - offsetY;
                newLeft = Math.max(viewerRect.left, Math.min(newLeft, viewerRect.right - navBar.offsetWidth));
                newTop = Math.max(viewerRect.top, Math.min(newTop, viewerRect.bottom - navBar.offsetHeight));
                navBar.style.left = `${newLeft - viewerRect.left}px`;
                navBar.style.top = `${newTop - viewerRect.top}px`;
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });

        // PDF handling
        uploadButton.addEventListener('click', () => pdfUpload.click());

        pdfUpload.addEventListener('change', async e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async function() {
                    const data = reader.result;
                    const pdfId = Date.now();
                    const title = file.name.length > 20 ? file.name.substring(0, 17) + '...' : file.name;
                    pdfs.push({ id: pdfId, title, data, currentPage: 1 });
                    addTab(pdfId, title);
                    setActiveTab(pdfId);
                    await loadPdf(pdfId);
                };
                reader.readAsArrayBuffer(file);
                e.target.value = ''; // Reset input
            }
        });

        function addTab(id, title) {
            const tab = document.createElement('div');
            tab.className = 'tab';
            tab.dataset.pdfId = id;
            tab.innerHTML = `<span class="tab-title">${title}</span><button class="close-tab">x</button>`;
            pdfTabs.insertBefore(tab, uploadButton);
            tab.addEventListener('click', () => setActiveTab(id));
            tab.querySelector('.close-tab').addEventListener('click', e => {
                e.stopPropagation();
                closeTab(id);
            });
        }

        function setActiveTab(id) {
            activePdfId = id;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const activeTab = document.querySelector(`.tab[data-pdf-id="${id}"]`);
            if (activeTab) activeTab.classList.add('active');
            loadPdf(id);
        }

        async function loadPdf(id) {
            const pdfObj = pdfs.find(p => p.id === id);
            if (!pdfObj) {
                pdfCanvas.style.display = 'none';
                pageCount.textContent = '';
                return;
            }
            pdfCanvas.style.display = 'block';
            const pdf = await pdfjsLib.getDocument({ data: pdfObj.data }).promise;
            pdfObj.pdf = pdf;
            pageCount.textContent = `of ${pdf.numPages}`;
            renderPage(pdfObj);
        }

        async function renderPage(pdfObj) {
            const page = await pdfObj.pdf.getPage(pdfObj.currentPage);
            const viewport = page.getViewport({ scale: 1 });
            const scale = column1.clientWidth / viewport.width;
            const scaledViewport = page.getViewport({ scale });
            const context = pdfCanvas.getContext('2d');
            pdfCanvas.width = scaledViewport.width;
            pdfCanvas.height = scaledViewport.height;
            await page.render({ canvasContext: context, viewport: scaledViewport }).promise;
            pageNum.value = pdfObj.currentPage;
        }

        function closeTab(id) {
            pdfs = pdfs.filter(p => p.id !== id);
            const tab = document.querySelector(`.tab[data-pdf-id="${id}"]`);
            tab.remove();
            if (activePdfId === id) {
                const nextPdf = pdfs[0];
                if (nextPdf) {
                    setActiveTab(nextPdf.id);
                } else {
                    activePdfId = null;
                    pdfCanvas.style.display = 'none';
                    pageCount.textContent = '';
                }
            }
        }

        prevPage.addEventListener('click', () => {
            const pdfObj = pdfs.find(p => p.id === activePdfId);
            if (pdfObj && pdfObj.currentPage > 1) {
                pdfObj.currentPage--;
                renderPage(pdfObj);
            }
        });

        nextPage.addEventListener('click', () => {
            const pdfObj = pdfs.find(p => p.id === activePdfId);
            if (pdfObj && pdfObj.currentPage < pdfObj.pdf.numPages) {
                pdfObj.currentPage++;
                renderPage(pdfObj);
            }
        });

        pageNum.addEventListener('change', () => {
            const pdfObj = pdfs.find(p => p.id === activePdfId);
            if (pdfObj) {
                let page = parseInt(pageNum.value);
                if (page >= 1 && page <= pdfObj.pdf.numPages) {
                    pdfObj.currentPage = page;
                    renderPage(pdfObj);
                } else {
                    pageNum.value = pdfObj.currentPage;
                }
            }
        });

        // Markdown handling
        markdownInput.addEventListener('input', () => {
            markdownRendered.innerHTML = marked.parse(markdownInput.value);
        });

        saveMdButton.addEventListener('click', () => {
            const blob = new Blob([markdownInput.value], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'notes.md';
            a.click();
            URL.revokeObjectURL(url);
        });

        exportWordButton.addEventListener('click', () => {
            const htmlContent = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
                <head><meta charset="utf-8"><title>Notes</title></head>
                <body>${markdownRendered.innerHTML}</body>
                </html>`;
            const blob = new Blob([htmlContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'notes.doc';
            a.click();
            URL.revokeObjectURL(url);
        });

        // Wikipedia search
        let debounceTimer;

        wikiSearch.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const query = wikiSearch.value.trim();
                if (query) {
                    searchWikipedia(query);
                } else {
                    wikiResults.innerHTML = '';
                }
            }, 300);
        });

        async function searchWikipedia(query) {
            const url = `https://en.wikipedia.org/w/api.php?action=query&generator=search&gsrsearch=${encodeURIComponent(query)}&prop=extracts|pageimages&exsentences=2&exintro&explaintext&format=json&origin=*`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                const pages = data.query?.pages || {};
                wikiResults.innerHTML = '';
                for (const pageId in pages) {
                    const page = pages[pageId];
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'wiki-result';
                    let imgHtml = page.thumbnail ? `<img src="${page.thumbnail.source}" alt="${page.title}">` : '';
                    resultDiv.innerHTML = `
                        ${imgHtml}
                        <h3>${page.title}</h3>
                        <p>${page.extract || 'No summary available.'}</p>
                        <a href="https://en.wikipedia.org/wiki/${encodeURIComponent(page.title)}" target="_blank">Read more</a>
                    `;
                    wikiResults.appendChild(resultDiv);
                }
            } catch (error) {
                wikiResults.innerHTML = '<p>Error fetching results.</p>';
            }
        }
    </script>
</body>
</html>