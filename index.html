<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Multi-Tool Web App</title>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      background-color: #2b2b2b;
      color: #f0f0f0;
      font-family: Arial, sans-serif;
    }
    #container {
      display: flex;
      height: 100%;
      width: 100%;
    }
    /* Columns */
    #col1, #col2, #col3 {
      overflow: auto;
      padding: 10px;
      box-sizing: border-box;
    }
    #col1 {
      flex: 1;
      position: relative;
    }
    #col2 {
      width: 350px;
    }
    #col3 {
      width: 350px;
    }
    /* Resizers */
    .resizer {
      width: 5px;
      cursor: ew-resize;
      background-color: #444;
    }
    /* PDF viewer and tabs */
    #pdf-tabs {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    #pdf-tab-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-wrap: wrap;
    }
    #pdf-tab-list li {
      margin-right: 5px;
      padding: 5px;
      background: #444;
      cursor: pointer;
    }
    #pdf-tab-list li.active {
      background: #666;
    }
    #pdf-nav {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #333;
      padding: 5px;
      border: 1px solid #555;
      z-index: 10;
      cursor: move;
    }
    canvas {
      display: block;
      max-width: 100%;
      margin-top: 50px; /* leave space for the nav bar */
    }
    /* Note taking styles */
    #raw-notes {
      width: 100%;
      height: 40%;
      background: #333;
      color: #f0f0f0;
      border: none;
      padding: 10px;
      box-sizing: border-box;
      resize: none;
    }
    #rendered-notes {
      width: 100%;
      height: 40%;
      background: #222;
      color: #f0f0f0;
      padding: 10px;
      box-sizing: border-box;
      overflow: auto;
      margin-top: 10px;
    }
    button {
      background: #555;
      color: #f0f0f0;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      margin-top: 5px;
    }
    button:hover {
      background: #777;
    }
    /* Wikipedia search */
    #wiki-query {
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
      background: #333;
      color: #f0f0f0;
      border: 1px solid #555;
    }
    .wiki-result {
      border-bottom: 1px solid #444;
      padding: 10px 0;
      display: flex;
      align-items: center;
    }
    .wiki-result img {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- Column 1: PDF Viewer -->
    <div id="col1">
      <div id="pdf-tabs">
        <ul id="pdf-tab-list"></ul>
        <button id="add-pdf-btn" title="Add PDF">+</button>
      </div>
      <div id="pdf-viewer">
        <div id="pdf-nav">
          <button id="prev-page">Prev</button>
          <span>Page <span id="current-page">1</span> of <span id="total-pages">?</span></span>
          <input type="number" id="page-number-input" min="1" style="width:50px;">
          <button id="go-to-page">Go</button>
          <button id="next-page">Next</button>
        </div>
        <canvas id="pdf-canvas"></canvas>
      </div>
      <input type="file" id="pdf-upload" accept="application/pdf" style="display:none;">
    </div>
    <div class="resizer" id="resizer1"></div>
    <!-- Column 2: Note Taking -->
    <div id="col2">
      <h2>Notes</h2>
      <textarea id="raw-notes" placeholder="Enter markdown here..."></textarea>
      <button id="save-raw">Save Raw Markdown</button>
      <div id="rendered-notes"></div>
      <button id="save-doc">Save as MS Word</button>
    </div>
    <div class="resizer" id="resizer2"></div>
    <!-- Column 3: Wikipedia Search -->
    <div id="col3">
      <h2>Wikipedia Search</h2>
      <input type="text" id="wiki-query" placeholder="Search Wikipedia...">
      <div id="wiki-results"></div>
    </div>
  </div>

  <!-- External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.2.12/marked.min.js"></script>

  <script>
    /* ================= PDF Viewer (Column 1) ================= */
    let pdfs = []; // Holds objects { pdfDoc, currentPage, totalPages, name }
    let currentPdfIndex = -1;
    const pdfCanvas = document.getElementById('pdf-canvas');
    const ctx = pdfCanvas.getContext('2d');
    const pdfUpload = document.getElementById('pdf-upload');
    const pdfTabList = document.getElementById('pdf-tab-list');

    document.getElementById('add-pdf-btn').addEventListener('click', () => {
      pdfUpload.click();
    });

    pdfUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file && file.type === 'application/pdf') {
        loadPDF(file);
      }
      e.target.value = "";
    });

    function loadPDF(file) {
      const fileReader = new FileReader();
      fileReader.onload = function() {
        const typedarray = new Uint8Array(this.result);
        pdfjsLib.getDocument(typedarray).promise.then(function(pdfDoc) {
          const pdfData = {
            pdfDoc: pdfDoc,
            currentPage: 1,
            totalPages: pdfDoc.numPages,
            name: file.name
          };
          pdfs.push(pdfData);
          currentPdfIndex = pdfs.length - 1;
          addPdfTab(pdfData, currentPdfIndex);
          renderPage(pdfData.currentPage);
          updateNav();
        }).catch(function(error) {
          alert('Error loading PDF: ' + error);
        });
      };
      fileReader.readAsArrayBuffer(file);
    }

    function addPdfTab(pdfData, index) {
      const li = document.createElement('li');
      li.textContent = pdfData.name;
      li.dataset.index = index;
      li.addEventListener('click', () => {
        currentPdfIndex = parseInt(li.dataset.index);
        renderPage(pdfs[currentPdfIndex].currentPage);
        updateNav();
        updateTabs();
      });
      pdfTabList.appendChild(li);
      updateTabs();
    }

    function updateTabs() {
      const tabs = pdfTabList.querySelectorAll('li');
      tabs.forEach(tab => {
        tab.classList.toggle('active', parseInt(tab.dataset.index) === currentPdfIndex);
      });
    }

    function renderPage(num) {
      if (currentPdfIndex < 0) return;
      const pdfData = pdfs[currentPdfIndex];
      pdfData.pdfDoc.getPage(num).then(function(page) {
        // Calculate scale so that the PDF fills the column's width
        const viewport = page.getViewport({ scale: 1 });
        const colWidth = document.getElementById('col1').clientWidth - 20;
        const scale = colWidth / viewport.width;
        const scaledViewport = page.getViewport({ scale: scale });
        pdfCanvas.height = scaledViewport.height;
        pdfCanvas.width = scaledViewport.width;
        const renderContext = {
          canvasContext: ctx,
          viewport: scaledViewport
        };
        page.render(renderContext);
        pdfData.currentPage = num;
        updateNav();
      });
    }

    function updateNav() {
      if (currentPdfIndex < 0) return;
      const pdfData = pdfs[currentPdfIndex];
      document.getElementById('current-page').textContent = pdfData.currentPage;
      document.getElementById('total-pages').textContent = pdfData.totalPages;
    }

    document.getElementById('prev-page').addEventListener('click', () => {
      if (currentPdfIndex < 0) return;
      if (pdfs[currentPdfIndex].currentPage > 1) {
        renderPage(pdfs[currentPdfIndex].currentPage - 1);
      }
    });

    document.getElementById('next-page').addEventListener('click', () => {
      if (currentPdfIndex < 0) return;
      if (pdfs[currentPdfIndex].currentPage < pdfs[currentPdfIndex].totalPages) {
        renderPage(pdfs[currentPdfIndex].currentPage + 1);
      }
    });

    document.getElementById('go-to-page').addEventListener('click', () => {
      if (currentPdfIndex < 0) return;
      const pageNumber = parseInt(document.getElementById('page-number-input').value);
      if (pageNumber >= 1 && pageNumber <= pdfs[currentPdfIndex].totalPages) {
        renderPage(pageNumber);
      }
    });

    // Redraw PDF on window resize
    window.addEventListener('resize', () => {
      if (currentPdfIndex >= 0) {
        renderPage(pdfs[currentPdfIndex].currentPage);
      }
    });

    // Make the PDF navigation bar draggable
    (function() {
      const nav = document.getElementById('pdf-nav');
      let offsetX, offsetY, isDragging = false;
      nav.addEventListener('mousedown', function(e) {
        isDragging = true;
        offsetX = e.clientX - nav.offsetLeft;
        offsetY = e.clientY - nav.offsetTop;
      });
      document.addEventListener('mousemove', function(e) {
        if (isDragging) {
          nav.style.left = (e.clientX - offsetX) + 'px';
          nav.style.top = (e.clientY - offsetY) + 'px';
        }
      });
      document.addEventListener('mouseup', function() {
        isDragging = false;
      });
    })();

    /* ================= Resizable Columns ================= */
    (function() {
      const resizer1 = document.getElementById('resizer1');
      const resizer2 = document.getElementById('resizer2');
      const col1 = document.getElementById('col1');
      const col2 = document.getElementById('col2');
      const col3 = document.getElementById('col3');

      // Resizer between Column 1 and Column 2
      resizer1.addEventListener('mousedown', initDrag1);
      function initDrag1(e) {
        window.addEventListener('mousemove', startDrag1);
        window.addEventListener('mouseup', stopDrag1);
      }
      function startDrag1(e) {
        let newWidth = e.clientX - col1.getBoundingClientRect().left;
        col1.style.flex = 'none';
        col1.style.width = newWidth + 'px';
      }
      function stopDrag1(e) {
        window.removeEventListener('mousemove', startDrag1);
        window.removeEventListener('mouseup', stopDrag1);
      }

      // Resizer between Column 2 and Column 3
      resizer2.addEventListener('mousedown', initDrag2);
      function initDrag2(e) {
        window.addEventListener('mousemove', startDrag2);
        window.addEventListener('mouseup', stopDrag2);
      }
      function startDrag2(e) {
        const col2Rect = col2.getBoundingClientRect();
        let newWidth = e.clientX - col2Rect.left;
        col2.style.width = newWidth + 'px';
      }
      function stopDrag2(e) {
        window.removeEventListener('mousemove', startDrag2);
        window.removeEventListener('mouseup', stopDrag2);
      }
    })();

    /* ================= Note Taking & Markdown (Column 2) ================= */
    const rawNotes = document.getElementById('raw-notes');
    const renderedNotes = document.getElementById('rendered-notes');

    function updateRenderedNotes() {
      renderedNotes.innerHTML = marked.parse(rawNotes.value);
    }
    rawNotes.addEventListener('input', updateRenderedNotes);
    updateRenderedNotes();

    document.getElementById('save-raw').addEventListener('click', function() {
      const blob = new Blob([rawNotes.value], { type: "text/plain;charset=utf-8" });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = "notes.md";
      link.click();
    });

    document.getElementById('save-doc').addEventListener('click', function() {
      const content = '<html><head><meta charset="UTF-8"></head><body>' + renderedNotes.innerHTML + '</body></html>';
      const blob = new Blob([content], { type: "application/msword" });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = "notes.doc";
      link.click();
    });

    /* ================= Wikipedia Live Search (Column 3) ================= */
    const wikiQuery = document.getElementById('wiki-query');
    const wikiResults = document.getElementById('wiki-results');
    let wikiTimeout = null;

    wikiQuery.addEventListener('input', function() {
      clearTimeout(wikiTimeout);
      const query = wikiQuery.value.trim();
      if (query.length === 0) {
        wikiResults.innerHTML = "";
        return;
      }
      wikiTimeout = setTimeout(() => {
        fetchWikipedia(query);
      }, 300);
    });

    function fetchWikipedia(query) {
      const url = 'https://en.wikipedia.org/w/api.php?' + new URLSearchParams({
        action: 'query',
        format: 'json',
        origin: '*',
        prop: 'pageimages|extracts',
        exintro: '1',
        explaintext: '1',
        pithumbsize: '100',
        generator: 'search',
        gsrsearch: query,
        gsrlimit: '10'
      });
      fetch(url)
        .then(response => response.json())
        .then(data => {
          wikiResults.innerHTML = "";
          if (data.query && data.query.pages) {
            let pages = Object.values(data.query.pages);
            pages.sort((a, b) => a.index - b.index);
            pages.forEach(page => {
              const div = document.createElement('div');
              div.className = 'wiki-result';
              if (page.thumbnail && page.thumbnail.source) {
                const img = document.createElement('img');
                img.src = page.thumbnail.source;
                img.width = 50;
                img.height = 50;
                div.appendChild(img);
              }
              const info = document.createElement('div');
              const title = document.createElement('h3');
              title.textContent = page.title;
              const extract = document.createElement('p');
              extract.textContent = page.extract;
              const link = document.createElement('a');
              link.href = 'https://en.wikipedia.org/?curid=' + page.pageid;
              link.textContent = 'Read more';
              link.target = '_blank';
              info.appendChild(title);
              info.appendChild(extract);
              info.appendChild(link);
              div.appendChild(info);
              wikiResults.appendChild(div);
            });
          }
        })
        .catch(error => {
          wikiResults.innerHTML = "Error fetching results.";
          console.error(error);
        });
    }
  </script>
</body>
</html>
